const mdns = require("mdns-js");
const hdaApi = require("./api");

const MDNS_TIMEOUT = 3000;
const A_MATCH = 0;

module.exports = {
  discover
};

function discover() {
  return new Promise((resolve, reject) => {
    let discoveredApi = [];
    let discovered = [];

    let mdnsBrowserOld = mdns.createBrowser("_http._tcp");  //older models
    let mdnsBrowserNew = mdns.createBrowser("_hda._tcp");   //Newer-models

    console.log("Discovery:  Start");
    mdnsBrowserOld.on("ready", function() {
      mdnsBrowserOld.discover();
    });

    mdnsBrowserNew.on("ready", function() {
      mdnsBrowserNew.discover();
    });

    mdnsBrowserOld.on("update", function(mdnsResponceData) {
      if (isMdnsDataMhub(mdnsResponceData) && isUnique(discovered, mdnsResponceData.host)) {
        console.log(`Discovery(OLD):  ${mdnsResponceData.host}`);
        discovered.push(mdnsResponceData.host);
        discoveredApi.push(new hdaApi(mdnsResponceData.host));
      }
    });

    mdnsBrowserNew.on("update", function(mdnsResponceData) {
      if (isMdnsDataMhub(mdnsResponceData) && isUnique(discovered, mdnsResponceData.host)) {
        console.log(`Discovery(NEW):  ${mdnsResponceData.host}`);
        discovered.push(mdnsResponceData.host);
        discoveredApi.push(new hdaApi(mdnsResponceData.host));
      }
    });

    setTimeout(() => {
      mdnsBrowserOld.stop();
      mdnsBrowserNew.stop();
      console.log("Discovery:  Stop");
      resolve(discoveredApi);
    }, MDNS_TIMEOUT);
  });
}

//is data from a MHUB device?
function isMdnsDataMhub(mdnsData) {
  return typeof mdnsData.txt == "object" && typeof mdnsData.txt[0] == "string" && mdnsData.txt[0].search("MHUB") == A_MATCH;
}

function isUnique(array, element) {
  return array.indexOf(element) === -1;
}
